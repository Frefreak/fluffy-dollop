<!DOCTYPE HTML>
<html><head><link rel="stylesheet" media="all" href="https://assets-cdn.github.com/assets/github-2d139b4bd0a4399b6d2c23de045ecf657e33e1c06fbfa4eb4d931df4edb28900.css"><link rel="stylesheet" media="all" href="https://assets-cdn.github.com/assets/github2-2dd6d5521b06801a26cd68af011ba6be68e775391549ab5378895caf9bb5d709.css"><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script></head><body><div class="container new-discussion-timeline experiment-repo-nav"><div class="repository-content"><div class="file"><div id="readme" class="blob instapaper_body"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><h2>
<a id="user-content-database" class="anchor" href="#database" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Database</h2>

<ul>
<li>
<p>user</p>

<ul>
<li>uid       Integer</li>
<li>username  string</li>
<li>md5password   hex string</li>
<li>key       hex string, used for AES encryption (generated from username/pwd)</li>
</ul>
</li>
<li>
<p>token_map</p>

<ul>
<li>token     hex string, used for uniquely identify client</li>
<li>uid       Integer, user id</li>
</ul>
</li>
<li>
<p>id_map</p>

<ul>
<li>uid       Integer, user id</li>
<li>[token]   hex string, same meaning as above</li>
</ul>
</li>
</ul>

<h2>
<a id="user-content-api" class="anchor" href="#api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>API</h2>

<hr>

<h3>
<a id="user-content-register" class="anchor" href="#register" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REGISTER</h3>

<p>(server respond as soon as possible)</p>

<p><strong>/register</strong></p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>theusername(RSA)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>md5'ed password(RSA)<span class="pl-pds">"</span></span>
    }</pre></div>

<p>server: store <code>(username, md5'ed password, token)</code> in database where 
token is generated from username and password. and respond.</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>200<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
    }</pre></div>

<p>on success,</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>400, 422<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>bad request, or username already existed<span class="pl-pds">"</span></span>
    }</pre></div>

<p>invalid json/invalid field or username existed</p>

<hr>

<h3>
<a id="user-content-login" class="anchor" href="#login" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LOGIN</h3>

<p>(server respond as soon as possible)</p>

<p><strong>/login</strong></p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>theusername(RSA)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>md5'ed password(RSA)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>deviceName<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Nexus, Huawei, Xiaomi, Chromium...(RSA)<span class="pl-pds">"</span></span>
    }</pre></div>

<p>server: autheticate by querying database, return</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>200<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>aes encrypted token(possibly base64'ed)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
    }</pre></div>

<p>on success,</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>400, 422<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>bad request or wrong username/pwd<span class="pl-pds">"</span></span>
    }</pre></div>

<p>invalid json or wrong username / pwd</p>

<p>then the server will add this token to a memory/physical database as
tuple: <del><code>(uid, connection, token, devicename)</code></del>(see the datatype at end)
token is used to identify different devices owned by one account</p>

<p>the client should keep the token carefully and include it to communicate
with server afterwards.</p>

<hr>

<h3>
<a id="user-content-post" class="anchor" href="#post" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>POST</h3>

<p>(server response as soon as possible)</p>

<p><strong>/post</strong></p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>previously gotten token(RSA)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>data<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>rsa encrypted data (RSA)<span class="pl-pds">"</span></span>
    }</pre></div>

<p>server: server add data to message queue which is to be send</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>200<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
    }</pre></div>

<p>on success or</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>400<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>bad request, etc<span class="pl-pds">"</span></span>
    }</pre></div>

<hr>

<h3>
<a id="user-content-sync" class="anchor" href="#sync" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SYNC</h3>

<p>(server hold the connection, send back message whenever the message queue is not empty)</p>

<p><strong>/sync</strong></p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>previously gotten token(RSA)<span class="pl-pds">"</span></span>
    }</pre></div>

<p>server: when there's new message, send that to client</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>aes encrypted message, (AES and base64)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msgid<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>a number indicating the msg id, (AES and base64)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>(optional)time<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>message time, (maybe added later)<span class="pl-pds">"</span></span>
    }</pre></div>

<p>then, if the client received the message, send an ACK:</p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>msgid<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>received msg id<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span>
    }</pre></div>

<p>after the server gets this ack, it deleted the msg stored and proceed 
to the next one(wait when msg queue empty)</p>

<p>It is the client's duty to start the ping frame (to keep the connection),
and reconnect whenever it detects disconnect. When a disconnect happens,
the server will keep the unsend message and wait for the same token to
connect back, then send the remaining message.</p>

<hr>

<h3>
<a id="user-content-logout" class="anchor" href="#logout" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LOGOUT</h3>

<p>(server respond as soon as possible)</p>

<p><strong>/logout</strong></p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>previously gotten token (RSA)<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>(optional)reason<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>reason, (maybe added later)<span class="pl-pds">"</span></span>
    }</pre></div>

<p>then server send back an ack.</p>

<p>server:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>200<span class="pl-pds">"</span></span>
    }</pre></div>

<p>on success or</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>400<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>bad request<span class="pl-pds">"</span></span>
    }</pre></div>

<p>when bad formatted json or no such token then the server clears 
all the message related to that token.</p>

<hr>

<h3>
<a id="user-content-ping" class="anchor" href="#ping" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>PING</h3>

<p>(server respond as soon as possible)</p>

<p><strong>/ping</strong></p>

<p>client:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>previously got token<span class="pl-pds">"</span></span>
    }</pre></div>

<p>then server send back <strong>ack</strong> when success
server:</p>

<div class="highlight highlight-source-json"><pre>    {
        <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>200<span class="pl-pds">"</span></span>
        <span class="pl-s"><span class="pl-pds">"</span>msg<span class="pl-pds">"</span></span><span class="pl-ii">:</span> <span class="pl-s"><span class="pl-pds">"</span>ack<span class="pl-pds">"</span></span>
    }</pre></div>

<p><code>400</code> or <code>422</code> when on error, which is explained in msg.</p>

<hr>

<h2>
<a id="user-content-datatypes" class="anchor" href="#datatypes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>datatypes</h2>

<ul>
<li>
<code>Map token MessageQueue</code> -&gt; memory as MVar</li>
</ul>

<p>so when the server restart, all messages lost, but tokens is restored</p>
</article></div></div></div></div><script>
$("span[class='octicon octicon-link']").replaceWith('<svg aria-hidden="true" class="octicon octicon-link" height="16" role="img" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path></svg>')</script></body></html>